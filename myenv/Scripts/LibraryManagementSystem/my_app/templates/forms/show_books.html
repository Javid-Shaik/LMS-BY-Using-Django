<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% extends 'forms/base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" type="text/css" href="{% static 'css/show_books.css' %}">
<section >
    <table class="books book-details">
        <tr>
            <td colspan="8" id="borrowNotification"></td>
        </tr>
        <tr>
            <th>SI.NO</th>
            <th>Book Details</th>
            <th>Author(s)</th>
            <th>ISBN</th>
            <th>Publisher</th>
            <th>Publication</th>
            <th>Edition</th>
            <th>Borrow</th>
        </tr>
        {% for book in books %}
        <tr>
            <td class="sino">{{ forloop.counter }}</td>
            <td>
                <div class="cover-image">
                    <img src= "{{ book.cover_image.url }}" alt="Cover Image">
                </div>
                <p>{{ book.title }}</p>
            </td>
            <td>{{ book.author_name }}
            <td>{{ book.isbn }}</td>
            <td>{{ book.publisher }}</td>
            <td>{{ book.publication }}</td>
            <td>{{ book.edition }}</td>
            <td>
                <button class="btn btn-primary borrow-button" data-bs-toggle="modal" data-bs-target="#exampleModal">
                    <a href="{% url 'borrow_books' book_id=book.id %}" ></a>Borrow
                </button>
            </td>
        </tr>
        {% endfor %}
    </table>
</section>
{% include 'pop_up_msg.html'%}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        $('.borrow-button').click(function(e) {
            e.preventDefault();
            var url = $(this).find('a').attr('href');
            $.ajax({
                url: url,
                type: 'GET',
                success: function(response) {
                    var message = response.message;
                    var success = response.success;
                    showBorrowNotification(message, success);
                },
                error: function(xhr, textStatus, errorThrown) {
                    console.log(xhr.responseText);
                }
            });
        });
        function showBorrowNotification(message , success) {
            // Intercept the AJAX response when the user borrows a book
            $(document).ajaxComplete(function (event, xhr, settings) {
                // Check if the response contains the message and success status
                if (settings.url.includes('/borrow_books/') && xhr.responseJSON) {
                    const response = xhr.responseJSON;
                    if (response.success) {
                        // Show the success message in the modal
                        $('#borrowMessageText').text(response.message);
                        $('#borrowMessageModal').modal('show');
                    } else {
                        // Show the error message in the modal
                        $('#borrowMessageText').text(response.message);
                        $('#borrowMessageText').style.color = "red";
                        $('#borrowMessageModal').modal('show');
                    }
                }
            });
        }
    });
</script>
{% endblock %}